package cs333;

import javafx.fxml.FXML;
import javafx.scene.control.Button;
import javafx.scene.control.ComboBox;
import javafx.scene.control.TextField;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.scene.control.ListView;

public class UnitConverterController {

	@FXML
	private ComboBox<String> modeComboBox; // "English → Metric" or "Metric → English"
	@FXML
	private ComboBox<String> unitTypeComboBox; // "Weight", "Length", "Temperature", "Speed"
	@FXML
	private ListView<String> historyListView;

	private final ObservableList<String> historyItems = FXCollections.observableArrayList();

	@FXML
	private TextField valueTextField;
	@FXML
	private TextField resultTextField;
	@FXML
	private Button converterButton;

	@FXML
	private void handleClearHistory() {
		historyItems.clear();
	}

	@FXML
	public void initialize() {
		// Populate dropdowns here (avoids FXML <String> parsing issues)
		modeComboBox.getItems().setAll("English → Metric", "Metric → English");
		modeComboBox.getSelectionModel().selectFirst();

		unitTypeComboBox.getItems().setAll("Weight", "Length", "Temperature", "Speed");
		unitTypeComboBox.getSelectionModel().selectFirst();

		converterButton.setOnAction(e -> convertUnits());
		if (historyListView != null) {
			historyListView.setItems(historyItems);
		}
	}

	@FXML
	private void clearFields() {
		valueTextField.clear();
		resultTextField.clear();
	}

	private void convertUnits() {
		String mode = modeComboBox.getValue();
		String type = unitTypeComboBox.getValue();

		String raw = valueTextField.getText().trim();
		if (raw.isEmpty()) {
			resultTextField.setText("Enter a number first.");
			return;
		}

		double value;
		try {
			value = Double.parseDouble(raw);
		} catch (NumberFormatException ex) {
			resultTextField.setText("Invalid number.");
			return;
		}

		String result;
		switch (type) {
		case "Weight" -> {
			if (isMetricToEnglish(mode)) {
				// kg -> lb
				double pounds = value * 2.20462;
				result = String.format("%.2f kg → %.2f lb", value, pounds);
			} else {
				// lb -> kg
				double kg = value / 2.20462;
				result = String.format("%.2f lb → %.2f kg", value, kg);
			}
		}
		case "Length" -> {
			if (isMetricToEnglish(mode)) {
				// km -> mi
				double miles = value * 0.621371;
				result = String.format("%.2f km → %.2f mi", value, miles);
			} else {
				// mi -> km
				double km = value / 0.621371;
				result = String.format("%.2f mi → %.2f km", value, km);
			}
		}
		case "Temperature" -> {
			if (isMetricToEnglish(mode)) {
				// °C -> °F
				double f = (value * 9 / 5) + 32;
				result = String.format("%.2f °C → %.2f °F", value, f);
			} else {
				// °F -> °C
				double c = (value - 32) * 5 / 9;
				result = String.format("%.2f °F → %.2f °C", value, c);
			}
		}
		case "Speed" -> {
			if (isMetricToEnglish(mode)) {
				// km/h -> mph
				double mph = value * 0.621371;
				result = String.format("%.2f km/h → %.2f mph", value, mph);
			} else {
				// mph -> km/h
				double kph = value / 0.621371;
				result = String.format("%.2f mph → %.2f km/h", value, kph);
			}
		}
		default -> result = "Select a unit type.";
		}

		resultTextField.setText(result);
		addToHistory(valueTextField.getText(), result, unitTypeComboBox.getValue(), modeComboBox.getValue());

	}

	private boolean isMetricToEnglish(String mode) {
		return "Metric → English".equals(mode);
	}

	private void addToHistory(String input, String output, String unitType, String mode) {
		if (input == null || input.isBlank() || output == null || output.isBlank()) {
			return;
		}

		String safeUnitType = (unitType != null) ? unitType : "Unknown type";
		String safeMode = (mode != null) ? mode : "Unknown mode";

		// Example entry: "10 cm (Length, Metric → English) → 3.94 in"
		String entry = String.format("%s  (%s, %s)  →  %s", input.trim(), safeUnitType, safeMode, output.trim());

		// Add newest at the top
		historyItems.add(0, entry);

		// Keep the list from getting huge
		int MAX_HISTORY = 25;
		if (historyItems.size() > MAX_HISTORY) {
			historyItems.remove(MAX_HISTORY, historyItems.size());
		}
	}

	@FXML
	private void handleExit() {
		javafx.application.Platform.exit();
	}
}
